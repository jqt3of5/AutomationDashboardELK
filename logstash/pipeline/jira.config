input {
    jira_poller {
        baseurl => {
            method => get
            user => "${JIRA_USER}"
            password => "${JIRA_PWD}"
            url => "https://epm.verisk.com/jira"
            headers => {
                Accept => "application/json"
            }
        }
        projects => ["XMA", "XMI", "XMW", "XO"]
        jql => "updated > startOfYear() and issuetype != Test"
        schedule => { every => "60s"}
        codec => "json"
    }
}

filter {

    if [issues] {
        split {
            field => "[issues]"
        }
        mutate {
            lowercase => ["[issues][fields][project][key]"]
        }
        time_in_status {

        }
        ruby {
            path => "/usr/share/logstash/pipeline/story_points.rb"
        }
         #TODO: Normalize/transform data so that it has a consistent values accross the teams
    }
}

output {
    if [issues] {
        #file { path => "jira_issues_%{[issues][fields][project][key]}.json" }
        pipeline { send_to => [jira_issues, jira_transitions] }
    } else {
        #file { path => "jira_errors.json" }
        elasticsearch{
            index => "jira_polling_errors"
            hosts => ["elasticsearch:9200"]
        }

    }
}